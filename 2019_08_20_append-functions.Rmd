---
title: "Append Functions"
output: html_notebook
---

I need to write the functions to append probes for the Shiny app. I think that the following functions are probably necessary:

* append_same()
* append_unique()
* append_custom()

They need to have options to append left or right, and to my RNA scheme, or DNA scheme.

I'll work with the head of my probe set again as my example data frame.

```{r}
library(tidyverse)
```

```{r}
probes <- read_delim("/Users/hershe/Documents/OligoServer/probe_dbs/refseq_hg38_DNA-FISH_DB.csv",
                     col_names = c("chrom", "start", "stop", 
                                   "sequence", "Tm", "on-target",
                                   "off-target", "repeat", "max-kmer",
                                   "refseq"),
                     delim = "\t")

probes <- head(probes, 1000)
probes
```

And I'll also work with the 168 primers from Brian.
```{r}
primers <- read_tsv("./appending/168.primers.txt", col_names = c("ID",
                                                                 "primer"))

head(primers['primer'])
```

This is the mess that I need to refactor.
```{r}
# # work from inside out
#     if(input$fpp_choice) {
#       if(input$fpp_append_scheme == 1) {
#         if(input$fpp_sequence_select == 1) {
#           # this path will need to change
#           fpp_primer_file <- read_tsv("./appending/168.primers.txt",
#                                       col_names = c("ID",
#                                                     "primer"))
#           
#           fpp_primer_seqs <- unique(fpp_primer_file$primer)
#           
#           # determine if there are too few 5' primers to have a unique
#           # primer for each row
#           if(input$design_scheme) {
#             if(nrow(fpp_primer_seqs) < nrow(refseq_accessions())) {
#               stop("Error: There are less unique 5' primers than targets.")
#             }
#           } else {
#             if(nrow(fpp_primer_seqs) < nrow(coordinates())) {
#               stop("Error: There are less unique 5' primers than targets.")
#             }
#           }
#           
#           # add unique 5' primer to each target
#           if(input$design_scheme) {
#             refseq_targets <- unique(rna_probes$refseq)
#             
#             appended_probes <- list()
#             
#             for (i in 1:length(refseq_targets)) {
#               appended_probes[[i]] = rna_probes %>%
#                 filter(refseq == refseq_targets[i]) %>%
#                 mutate(sequence = str_c(fpp_primer_seqs[i], sequence), sep = "TTT")
#             }
#             
#             rna_probes <- bind_rows(appended_probes)
#           } else {
#             coord_targets <- unique(dna_probes$target)
#             
#             appended_probes <- list()
#             
#             for (i in 1:length(coord_targets)) {
#               appended_probes[[i]] = dna_probes %>%
#                 filter(refseq == coord_targets[i]) %>%
#                 mutate(sequence = str_c(fpp_primer_seqs[i], sequence))
#             }
#             
#             dna_probes <- bind_rows(appended_probes)
#           }
#         }
#       }
#     }
```

If the 5' primer has been selected to be appended, I need to do call one the three functions listed above. If the user chose to have the same primer for all probes, I will simply append the first primer from the list to the correct 5' primer position for each probe.

```{r}
append_same <- function(probes, sequences, left = TRUE) {
  # retrive first primer from list
  primer <- sequences$primer[1]
  
  # append to left or right
  if(left) {
    probes_appended <- probes %>%
      mutate(sequence = str_c(primer, sequence, sep = "TTT"))
  } else {
    probes_appended <- probes %>%
      mutate(sequence = str_c(sequence, primer, sep = "TTT"))
  }
  
  return(probes_appended)
}
```

Now I'll test it out

```{r}

probes_append_same <- append_same(probes, primers)

head(probes_append_same)
```

This works nicely.

**one thing to note:** The sequences df I'm passing as an argument will either be one of the PaintSHOP sets or a custom set.

If the user selects to append a unique 5' primer to each target, the append_unique() function will handle it.

```{r}
append_unique <- function(probes, sequences, rna = TRUE, left = TRUE) {
  # first test whether there are enough primers for every target
  if(rna) {
    if(nrow(sequences) < length(unique(probes$refseq))) {
      stop("Error: There are less unique 5' primers than targets.")
    }
  } else {
    if(nrow(sequences) < length(unique(probes$target))) {
      stop("Error: There are less unique 5' primers than targets.")
    }
  }
  
  # append one of the primers to each target
  if(rna) {
    unique_targets <- unique(probes$refseq)
    unique_sequences <- unique(sequences$primer)
    
    probes_appended_list <- list()
    
    for (i in 1:length(unique_targets)) {
      if(left) {
        probes_appended_list[[i]] <- probes %>%
          filter(refseq == unique_targets[i]) %>%
          mutate(sequence = str_c(unique_sequences[i], sequence, sep = "TTT"))
      } else {
        probes_appended_list[[i]] <- probes %>%
          filter(refseq == unique_targets[i]) %>%
          mutate(sequence = str_c(sequence, unique_sequences[i], sep = "TTT"))
      }
    }
    
    append_result <- bind_rows(probes_appended_list)
  } else {
    unique_targets <- unique(probes$target)
    unique_sequences <- unique(sequences$primer)
    
    probes_appended_list <- list()
    
    for (i in 1:length(unique_targets)) {
      if(left) {
        probes_appended_list[[i]] <- probes %>%
          filter(target == unique_targets[i]) %>%
          mutate(sequence = str_c(unique_sequences[i], sequence, sep = "TTT"))
      } else {
        probes_appended_list[[i]] <- probes %>%
          filter(target == unique_targets[i]) %>%
          mutate(sequence = str_c(sequence, unique_sequences[i], sep = "TTT"))
      }
    }
    
    append_result <- bind_rows(probes_appended_list)
  }
  
  return(append_result)
}
```

Testing it:
```{r}
probes_append_unique <- append_unique(probes, primers)

head(probes_append_unique)
```

Great.

The last situation that I need to handle is when a user inputs custom ranges to append primers to. For example, to append unique primers to probes 1-100, 201-300, etc.

```{r}
input_string <- "1-200, 201-400, 401-600, 601-800, 801-1000"

input_ranges <- str_split(input_string, ", ")[[1]]

input_ranges
```

First, I'll need a function that ensures the range provided actually matches the range of the probes.

```{r}
hyphen_range <- function(input_ranges) {
  range_vector <- c()
  
  for (i in 1:length(input_ranges)) {
    start <- as.numeric(str_split(input_ranges[i], "-")[[1]][1])
    stop <- as.numeric(str_split(input_ranges[i], "-")[[1]][2])
    
    new_range <- seq(start, stop)
    
    range_vector <- c(range_vector, new_range)
  }
  
  return(range_vector)
}
```

Testing on the example ranges vector:

```{r}
hyphen_ranges <- hyphen_range(input_ranges)
```

Nice.

Now with this helper function, I can handle the custom ranges scenario.

```{r}
append_custom <- function(probes, sequences, input_ranges, left = TRUE) {
  # first ensure that the input ranges cover the probe set
  input_range_numeric <- hyphen_range(input_ranges)
  
  probe_range <- seq(1, nrow(probes))
  
  if(input_range_numeric != probe_range) {
    stop("Error: The provided custom ranges don't cover the probes correctly.")
  }
  
  # also make sure that there enough probes to cover the ranges provided
  if(nrow(sequences) < length(unique(input_ranges))) {
    stop("Error: There are less unique 5' primers than custom ranges provided.")
  }
  
  unique_sequences <- unique(sequences$primer)
  
  probes_appended_list <- list()
  
  # append a unique 5' primer to each custom range
  for (i in 1:length(input_ranges)) {
    start <- as.numeric(str_split(input_ranges[i], "-")[[1]][1])
    stop <- as.numeric(str_split(input_ranges[i], "-")[[1]][2])
    
    if(left) {
      probes_appended_list[[i]] <- probes[start:stop,] %>%
      mutate(sequence = str_c(unique_sequences[i], sequence, sep = "TTT"))
    } else {
      probes_appended_list[[i]] <- probes[start:stop,] %>%
      mutate(sequence = str_c(sequence, unique_sequences[i], sep = "TTT"))
    }
  }
  
  append_result <- bind_rows(probes_appended_list)
  
  return(append_result)
}
```

Testing it:

```{r}
probes_append_custom <- append_custom(probes, primers, input_ranges)

head(probes_append_custom)
```

Alright, with these three functions, I should be able to handle appending with much less code.
